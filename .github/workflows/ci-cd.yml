name: CI/CD Auto Pull and Rebuild

on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  deploy-fatur:
    runs-on: [fatur]
    timeout-minutes: 30

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    - name: Set project path
      run: |
        PROJECT_PATH=$(find /home -name 'php-project-2' -type d 2>/dev/null | head -1)
        if [ -z "$PROJECT_PATH" ]; then
          echo "‚ùå Folder php-project-2 tidak ditemukan"
          exit 1
        fi
        echo "PROJECT_PATH=$PROJECT_PATH" >> $GITHUB_ENV
        echo "üìÅ Project path: $PROJECT_PATH"
    
    - name: Stop existing containers first
      run: |
        PROJECT_PATH=$(find /home -name 'php-project-2' -type d 2>/dev/null | head -1)
        if [ -n "$PROJECT_PATH" ]; then
          cd "$PROJECT_PATH"
          docker compose down || true
          # Kill any process using port 80
          sudo fuser -k 80/tcp || true
          sleep 5
        fi

    - name: Fix local repo by fresh clone
      working-directory: ${{ env.PROJECT_PATH }}
      run: |
        cd ${{ env.PROJECT_PATH }}
        # Backup current state
        if [ -d ".git" ]; then
          mv .git .git.backup || true
        fi
        
        # Fresh git setup
        git init
        git remote add origin https://github.com/Hasryl16/ProjectWAP.git || git remote set-url origin https://github.com/Hasryl16/ProjectWAP.git
        git fetch origin master
        git checkout -f master
        
        # Clean up backup
        rm -rf .git.backup || true

    - name: Pull latest changes
      working-directory: ${{ env.PROJECT_PATH }}
      run: |
        git fetch origin master
        git reset --hard origin/master
        git clean -fd

    - name: Clean Docker resources
      working-directory: ${{ env.PROJECT_PATH }}
      run: |
        # Remove old containers
        docker compose down -v || true
        
        # Clean up dangling images and containers
        docker system prune -f
        
        # Remove project-specific images only
        docker images | grep "php-project-2" | awk '{print $3}' | xargs -r docker rmi -f || true

    - name: Build and start containers
      working-directory: ${{ env.PROJECT_PATH }}
      run: |
        # Build with no cache
        docker compose build --no-cache
        
        # Start in detached mode
        docker compose up -d
        
        echo "‚úÖ Containers started"

    - name: Wait for services to be ready
      working-directory: ${{ env.PROJECT_PATH }}
      run: |
        echo "‚è≥ Waiting for services to initialize..."
        sleep 10
        
        # Wait for MySQL to be healthy
        echo "Checking MySQL health..."
        for i in {1..30}; do
          if docker compose exec -T mysql mysqladmin ping -h localhost -uroot -p1234 --silent 2>/dev/null; then
            echo "‚úÖ MySQL is ready"
            break
          fi
          echo "Waiting for MySQL... ($i/30)"
          sleep 2
        done
        
        # Wait for PHP-FPM
        echo "Checking PHP-FPM..."
        sleep 5
        
        # Show container status
        docker compose ps
        
        # Show logs if there are issues
        echo "üìã Container logs:"
        docker compose logs --tail=50

    - name: Verify containers are running
      working-directory: ${{ env.PROJECT_PATH }}
      run: |
        # Check if all containers are up
        if ! docker compose ps | grep -q "Up"; then
          echo "‚ùå Some containers are not running!"
          docker compose logs
          exit 1
        fi
        echo "‚úÖ All containers are running"

    - name: Health check
      working-directory: ${{ env.PROJECT_PATH }}
      run: |
        echo "üîç Running health checks..."

        # Wait a bit more for nginx to be fully ready
        sleep 5

        # Try multiple health check endpoints
        if curl -s -o /dev/null -w "%{http_code}" http://localhost:80 | grep -q "200\|301\|302"; then
          echo "‚úÖ Health check passed (HTTP 200/301/302)"
        elif curl -s -o /dev/null -w "%{http_code}" http://localhost:80/index.php | grep -q "200\|301\|302"; then
          echo "‚úÖ Health check passed on index.php"
        else
          echo "‚ö†Ô∏è Health check warning - checking details..."

          # Show more details
          echo "Curl response:"
          curl -v http://localhost:80 || true

          echo ""
          echo "Nginx logs:"
          docker compose logs nginx --tail=20

          echo ""
          echo "PHP logs:"
          docker compose logs php --tail=20

          # Don't fail if it's just a 403 (might be intentional)
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:80)
          if [ "$HTTP_CODE" = "403" ]; then
            echo "‚ö†Ô∏è Got 403 - this might be intentional (no index configured)"
            echo "‚úÖ Server is responding, continuing..."
          else
            exit 1
          fi
        fi

    - name: Deployment Summary
      if: always()
      working-directory: ${{ env.PROJECT_PATH }}
      run: |
        echo "üìä Deployment Summary"
        echo "===================="
        echo ""
        echo "Container Status:"
        docker compose ps
        echo ""
        echo "Port Mappings:"
        docker compose port nginx 80 || echo "Nginx port not exposed"
        echo ""
        echo "‚úÖ Deployment completed for runner: fatur"

  deploy-hasryl:
    runs-on: [php-project-2]
    timeout-minutes: 30

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    - name: Set project path
      run: |
        PROJECT_PATH=$(find /home -name 'php-project-2' -type d 2>/dev/null | head -1)
        if [ -z "$PROJECT_PATH" ]; then
          echo "‚ùå Folder php-project-2 tidak ditemukan"
          exit 1
        fi
        echo "PROJECT_PATH=$PROJECT_PATH" >> $GITHUB_ENV
        echo "üìÅ Project path: $PROJECT_PATH"
    
    - name: Stop existing containers first
      run: |
        PROJECT_PATH=$(find /home -name 'php-project-2' -type d 2>/dev/null | head -1)
        if [ -n "$PROJECT_PATH" ]; then
          cd "$PROJECT_PATH"
          docker compose down || true
          # Kill any process using port 80
          sudo fuser -k 80/tcp || true
          sleep 5
        fi

    - name: Fix local repo by fresh clone
      working-directory: ${{ env.PROJECT_PATH }}
      run: |
        cd ${{ env.PROJECT_PATH }}
        # Backup current state
        if [ -d ".git" ]; then
          mv .git .git.backup || true
        fi
        
        # Fresh git setup
        git init
        git remote add origin git@github.com:Hasryl16/ProjectWAP.git || git remote set-url origin git@github.com:Hasryl16/ProjectWAP.git
        git fetch origin master
        git checkout -f master
        
        # Clean up backup
        rm -rf .git.backup || true

    - name: Pull latest changes
      working-directory: ${{ env.PROJECT_PATH }}
      run: |
        git fetch origin master
        git reset --hard origin/master
        git clean -fd

    - name: Clean Docker resources
      working-directory: ${{ env.PROJECT_PATH }}
      run: |
        # Remove old containers
        docker compose down -v || true
        
        # Clean up dangling images and containers
        docker system prune -f
        
        # Remove project-specific images only
        docker images | grep "php-project-2" | awk '{print $3}' | xargs -r docker rmi -f || true

    - name: Build and start containers
      working-directory: ${{ env.PROJECT_PATH }}
      run: |
        # Build with no cache
        docker compose build --no-cache
        
        # Start in detached mode
        docker compose up -d
        
        echo "‚úÖ Containers started"

    - name: Wait for services to be ready
      working-directory: ${{ env.PROJECT_PATH }}
      run: |
        echo "‚è≥ Waiting for services to initialize..."
        sleep 10
        
        # Wait for MySQL to be healthy
        echo "Checking MySQL health..."
        for i in {1..30}; do
          if docker compose exec -T mysql mysqladmin ping -h localhost -uroot -p1234 --silent 2>/dev/null; then
            echo "‚úÖ MySQL is ready"
            break
          fi
          echo "Waiting for MySQL... ($i/30)"
          sleep 2
        done
        
        # Wait for PHP-FPM
        echo "Checking PHP-FPM..."
        sleep 5
        
        # Show container status
        docker compose ps
        
        # Show logs if there are issues
        echo "üìã Container logs:"
        docker compose logs --tail=50

    - name: Verify containers are running
      working-directory: ${{ env.PROJECT_PATH }}
      run: |
        # Check if all containers are up
        if ! docker compose ps | grep -q "Up"; then
          echo "‚ùå Some containers are not running!"
          docker compose logs
          exit 1
        fi
        echo "‚úÖ All containers are running"

    - name: Health check
      run: |
        echo "üîç Running health checks..."
        
        # Wait a bit more for nginx to be fully ready
        sleep 5
        
        # Try multiple health check endpoints
        if curl -f -s -o /dev/null -w "%{http_code}" http://localhost:80 | grep -q "200\|301\|302"; then
          echo "‚úÖ Health check passed (HTTP 200/301/302)"
        elif curl -f -s -o /dev/null -w "%{http_code}" http://localhost:80/index.php | grep -q "200\|301\|302"; then
          echo "‚úÖ Health check passed on index.php"
        else
          echo "‚ö†Ô∏è Health check warning - checking details..."
          
          # Show more details
          echo "Curl response:"
          curl -v http://localhost:80 || true
          
          echo ""
          echo "Nginx logs:"
          docker compose -f ${{ env.PROJECT_PATH }}/docker-compose.yml logs nginx --tail=20
          
          echo ""
          echo "PHP logs:"
          docker compose -f ${{ env.PROJECT_PATH }}/docker-compose.yml logs php --tail=20
          
          # Don't fail if it's just a 403 (might be intentional)
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:80)
          if [ "$HTTP_CODE" = "403" ]; then
            echo "‚ö†Ô∏è Got 403 - this might be intentional (no index configured)"
            echo "‚úÖ Server is responding, continuing..."
          else
            exit 1
          fi
        fi

    - name: Deployment Summary
      if: always()
      working-directory: ${{ env.PROJECT_PATH }}
      run: |
        echo "üìä Deployment Summary"
        echo "===================="
        echo ""
        echo "Container Status:"
        docker compose ps
        echo ""
        echo "Port Mappings:"
        docker compose port nginx 80 || echo "Nginx port not exposed"
        echo ""
        echo "‚úÖ Deployment completed for runner: hasryl"